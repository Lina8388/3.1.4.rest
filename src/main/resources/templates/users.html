<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">

    <link rel="icon" href="http://electronika.spb.ru/favicon.ico" type="image/x-icon">

    <title>Admin panel</title>

    <!-- Bootstrap CSS -->

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>


    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


</head>
<body>

<!--верхняя панель-->
<nav class="navbar  navbar-dark bg-dark ">

    <a class="navbar-brand" href="#">
        <b> <span sec:authentication="principal.email"/></b>
        <span> with roles:</span>
        <td th:text="${principal}"></td>
    </a>
    <ul class="nav navbar-nav navbar-right">
        <li class="nav-item">
            <a class="nav-link" href='/logout'>Logout</a>
        </li>
    </ul>
</nav>
<!--верхняя панель-->

<div class="container-fluid">
    <div class="row ">
        <!--боковая белая панель-->
        <div class="col-md-2 m-0 p-0 pt-4 ">
            <div class="d-grid gap-2">
                <br>
                <a href="/users" class="btn btn-primary active" role="button">Admin</a>
                <a href="/user" class="nav-link " role="button">User</a>
            </div>
        </div>

        <!--правая серая панель-->

        <div class="container col-md-10 pt-4 bg-light ">
            <h1 class="h2">Admin panel</h1>
            <ul class="nav nav-tabs " id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="users-table-tab" data-bs-toggle="tab"
                       data-bs-target="#users-table" type="button" role="tab" aria-controls="users-table"
                       aria-selected="true">Users table</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link " data-toggle="tab" id="new-user-tab" data-bs-toggle="tab"
                       data-bs-target="#new-user"
                       type="button" role="tab" aria-controls="new-user">New User</a>

                </li>
            </ul>


            <div class="tab-content border rounded" id="myTabContent">
                <br>
                <div class="tab-pane fade show active  bg-light" id="users-table" role="tabpanel"
                     aria-labelledby="users-table-tab">
                    <ul class="px-3">
                        <h5>All users</h5>
                    </ul>
                    <div class="table-responsive">
                        <div class="card">
                            <div class="card-body">
                                <table class="table table-striped bg-white" id="mainTableWithUsers">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Age</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Edit</th>
                                        <th>Delete</th>
                                    </tr>
                                    </thead>

                                    <tbody></tbody>

                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- new user-->
                <div class="tab-pane fade" id="newUser" role="tabpanel" aria-labelledby="new-user-tab">
                    <ul class="px-3">
                        <h5>Add new user</h5>
                    </ul>
                    <div class="table-responsive">
                        <div class="card">
                            <div class="card-body">
                                <table class="table table-striped bg-white">
                                    <thead>
                                    <div class="container">
                                        <div class="row">
                                            <div class="col-sm-3">
                                            </div>
                                            <div class="col-sm text-center">


                                                <form id="formNewUser">

                                                    <label><b>First name</b></label>
                                                    <input type="text" class="form-control " name="name" id="nameN">
                                                    <br>
                                                    <br>
                                                    <label><b>Last name</b></label>
                                                    <input type="text" class="form-control" name="surname"
                                                           id="surnameN"/>
                                                    <br>
                                                    <br>
                                                    <label><b>Age</b></label>
                                                    <input type="number" class="form-control" name="age" id="ageN"/>
                                                    <br>
                                                    <br>
                                                    <label><b>Email</b></label>
                                                    <input type="text" class="form-control" name="email" id="emailN"/>
                                                    <br>
                                                    <br>
                                                    <label><b>Password</b></label>
                                                    <input type="text" class="form-control" name="password"
                                                           id="passwordN"/>
                                                    <br>
                                                    <br>
                                                    <div class="form-group">
                                                        <label><b>Role</b></label>
                                                        <select id="roleN" name="role" multiple size="2"
                                                                class="form-control form-control-sm">
                                                            <option name="ADMIN" value="1">ADMIN</option>
                                                            <option name="USER" value="2">USER</option>
                                                        </select>
                                                        <br>
                                                    </div>
                                                    <input type="submit" class="btn btn-success" value="Add new user"/>
                                                </form>
                                            </div>
                                            <div class="col-sm-3">

                                            </div>
                                        </div>
                                    </div>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <canvas class="" height="900"></canvas>
        </div>
    </div>

</div>


<!--modal update-->
<div class="modal fade" id="modalEdit" aria-hidden="true" aria-labelledby="exampleModalLabel2"
     role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel2">Edit user</h5>
                <button aria-label="Close" class="close" data-dismiss="modal"
                        type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="text-align: center">
                    <div class="justify-content-center align-items-center">
                        <form id="formEdit">
                            <div class="form-group">
                                <label>ID
                                    <input class="form-control" id="idE"
                                           type="number"
                                           readonly/></label>
                            </div>
                            <div class="form-group">
                                <label>First name
                                    <input class="form-control" id="nameE"
                                           name="name"

                                           type="text"
                                           value=""/></label>
                            </div>
                            <div class="form-group">
                                <label>Last name
                                    <input class="form-control" id="surnameE"
                                           name="surname"
                                           type="text"
                                    /></label>
                            </div>
                            <div class="form-group">
                                <label>Age
                                    <input class="form-control" id="ageE"
                                           type="number"
                                           name="age"
                                    /></label>
                            </div>
                            <div class="form-group">
                                <label>Email
                                    <input class="form-control" id="emailE"
                                           type="email"
                                           name="email"
                                    /></label>
                            </div>
                            <div class="form-group">
                                <label>Password
                                    <input class="form-control" id="passwordE"
                                           name="password"
                                           type="password"/></label>
                            </div>
                            <div class="form-group">
                                <label><b>Role</b>
                                    <select id="roleE" name="role" multiple size="2"
                                            class="form-control form-control-sm">
                                        <option name="ADMIN" value="1">ADMIN</option>
                                        <option name="USER" value="2">USER</option>
                                    </select>
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal-footer">

                <button class="btn btn-secondary" data-dismiss="modal" type="button">Close
                </button>

                <button class="btn btn-primary" type="submit" id="editForm">Edit
                </button>
            </div>


        </div>
    </div>
</div>

<!-- модальное окно update

<div aria-hidden="true" aria-labelledby="exampleModalLabel2" id="editModal" class="modal fade"
       role="dialog" tabindex="-1">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel2">Edit user</h5>
                  <button aria-label="Close" class="close" data-dismiss="modal"
                          type="button">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body">
                  <div style="text-align: center">
                      <div class="justify-content-center align-items-center">
                          <form id="modalIdEdit">


                          </form>
                      </div>
                  </div>
              </div>

              <div class="modal-footer">

                  <button class="btn btn-secondary" data-dismiss="modal"
                          type="button">Close
                  </button>

                  <button class="btn btn-primary" type="submit">Edit
                  </button>
              </div>


          </div>
      </div>
  </div>-->


<!-- модальное окно delete-->
<div class="modal fade" id="modalDelete" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel" aria-hidden="true">

    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete user</h5>
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class=" justify-content-center align-items-center">
                        <form class="text-center" id="deleteForm ">
                            <div class="form-group">
                                <label>ID
                                    <input class="form-control" id="idD"
                                           type="number"
                                           readonly/></label>
                            </div>
                            <div class="form-group">
                                <label>First name
                                    <input class="form-control" id="nameD"
                                           name="name"

                                           type="text" readonly/></label>
                            </div>
                            <div class="form-group">
                                <label>Last name
                                    <input class="form-control" id="surnameD"
                                           name="surname"
                                           type="text"
                                           readonly/></label>
                            </div>
                            <div class="form-group">
                                <label>Age
                                    <input class="form-control" id="ageD"
                                           type="number" name="age"
                                           readonly/></label>
                            </div>
                            <div class="form-group">
                                <label>Email
                                    <input class="form-control" id="emailD"
                                           type="email" name="email"
                                           readonly/></label>
                            </div>
                            <div class="form-group">
                                <label>Password
                                    <input class="form-control" id="passwordD"
                                           name="password"
                                           type="password"
                                           readonly/></label>
                            </div>
                            <div class="form-group">
                                <label><b>Role</b>
                                    <select for="role" id="roleD" name="role" multiple size="2"
                                            class="form-control form-control-sm" readonly>
                                        <option value="ADMIN" adminSelect>ADMIN</option>
                                        <option value="USER" userSelect>USER</option>
                                    </select>
                                </label>
                            </div>

                        </form>
                    </div>


                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        data-dismiss="modal">Close
                </button>

                <button type="submit" class="btn btn-primary"
                        id="deleteForm">Delete
                </button>

            </div>
        </div>
    </div>

</div>


<script>


    const url = 'http://localhost:8080/admin'

    const idE = document.getElementById('idE')
    const nameE = document.getElementById('nameE')
    const surnameE = document.getElementById('surnameE')
    const ageE = document.getElementById('ageE')
    const emailE = document.getElementById('emailE')
    const passwordE = document.getElementById('passwordE')
    const roleE = document.getElementById('roleE')
    const modalEdit = new bootstrap.Modal(document.getElementById('modalEdit'))
    let opcion = ''
    let result = ''


    /*       таблица      */
   // function createAllUsersTable(users) {
        const getPost = document.querySelector('tbody');
        let output = '';

        fetch(url, {
            mode: "no-cors",
        })
            .then(res => res.json())
            .then(data => {
                data.forEach(user => {
                    output += `<tr>
                                    <td >${user.id}</td>
                                    <td >${user.name}</td>
                                    <td >${user.surname}</td>
                                    <td >${user.age}</td>
                                    <td >${user.email}</td>
<td > `
                    for (const r of user.roles) {
                        output += r.role + " ";
                    }
                    output += `</td>
                                <td><button class="btn btn-primary editButton" >Edit</button></td>
                                <td><button class="btn btn-danger deleteButton " >Delete</button></td>
</tr>`;
                });
                getPost.innerHTML = output;
            })
    //}
    /*     таблица     */












    /*добавление формы*/

    const on = (element, event, selector, handler) => {

        console.log(handler)

        element.addEventListener(event, e => {
            if (e.target.closest(selector)) {
                handler(e)
            }

        })
    }

    /*
     on(document, 'click', '.deleteButton', e =>{
         const fila = e.target.parentNode.parentNode
         const idDelete = fila.firstElementChild.innerHTML
         alertify.confirm(
    function (){
      fetch(url+id, {
          method: 'DELETE'
      })
        .then(res => res.json())
        .then(()=> location.reload())
    },

    function () {
        alertify.error('Delete error')
    }

         )
         console.log(fila)
     })
    */






    /*добавление формы*/

  /*  const getRoles = document.querySelector('option');
    let result2 = ''

    let idForm = 0
    on(document, 'click', '.editButton', e => {
        const fila = e.target.parentNode.parentNode
        idForm = fila.children[0].innerHTML
        const nameF = fila.children[1].innerHTML
        const surnameF = fila.children[2].innerHTML
        const ageF = fila.children[3].innerHTML
        const emailF = fila.children[4].innerHTML
        idE.value = idForm
        nameE.value = nameF
        surnameE.value = surnameF
        ageE.value = ageF
        emailE.value = emailF

          fetch(url, {
              mode: "no-cors",
          })
              .then(res => res.json())
              .then(data => {
                  data.forEach(user =>{
                      result+=` ${user.password} `
                      for (const r of user.roles) {
                          getRoles.innerHTML += r.role + " ";
                      }

                  });
                  passwordE.value= result
                  //roleE.value = result2
                 // console.log(result2)
                 // getRoles.innerHTML = result2;
                 // getRoles.dataset = result2;
              })
          //roleE.value = roleF
         // passwordE.value = 1
        opcion = 'edit'
        modalEdit.show()


        console.log('working')
    })*/

    /*добавление формы*/


/*


        let userForUpdate = {
            id: document.getElementById("idE").value,
            name: document.getElementById("nameE").value,
            age: document.getElementById("ageE").value,
            password: document.getElementById("passwordE").value,

        };
        fetch('/admin', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            body: JSON.stringify(userForUpdate)
        }).then(result => result.json()).then(json => createAllUsersTable(json));


*/
















    /*    const mostrar=(data)=>{
            data.forEach(a=>{
                output +=`<tr>
                                        <td >${user.id}</td>
                                        <td >${user.name}</td>
                                        <td >${user.surname}</td>
                                        <td >${user.age}</td>
                                        <td >${user.email}</td>
    <td > `
                for (const r of user.roles) {
                    output += r.role + " ";
                }
                output+=`</td></tr>`;
            })
            getPost.innerHTML = output;
        }*/


    //const formArticulo = document.querySelector('form')

    const formArticulo = document.getElementById('editForm')

    /*formArticulo.addEventListener('submit', (e)=>{
        e.preventDefault()
        if(opcion=='edit'){
            fetch(url,{
                method:'POST',
                headers:{
                    'Content-Type' :'application/json'
                },
                body: JSON.stringify({
                    name: name.value,
                    surname: surname.value,
                    age: age.value ,
                    email: email.value,
                   // role: role.value,
                    password: password.value
                })
            })
            .then(response => response.json())
            .then(data => {
                const newArticulo = []
                newArticulo.push(data)
                mostrar(newArticulo)
            })
        }


    })*/


    formArticulo.addEventListener('submit', (e) => {
        e.preventDefault()
        if (opcion == 'edit') {
            console.log('edit')
        }
    })


    const newPassword = document.getElementById('passwordN');
    const newFirstName = document.getElementById('nameN');
    const newLastName = document.getElementById('surnameN');
    const newAge = document.getElementById('ageN');
    const newUser = document.querySelector('#newUser');


    newUser.addEventListener('click', () => {

        password.value = '';
        name.value = '';
        surname.value = '';
        age.value = '';
        // newListRoleNames.value = '';
        //selectRoles.children[0].className = 'form-group text-center w-50 mx-auto'
    })


    const formNew = document.getElementById('formNewUser')

    //Add new user
    formNew.addEventListener('submit', e => {
        e.preventDefault();

        let roles = getRoles(Array.from(document.getElementById('newListRoleNames').selectedOptions));
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                password: newPassword.value,
                name: newFirstName.value,
                surname: newLastName.value,
                age: newAge.value,
            })
        }).then(res => {
            res.json().then(user => {
                let newUser = [];
                newUser.push(user);
                getAllUsers(newUser);
            })
        }).catch(error => console.log(error))

        document.getElementById('userTableLink').click();
    })


    /* update modal */

    /*
        const getPost2 = document.getElementById('modalIdEdit');

        let output2 ='';

        fetch(url, {
            mode: "no-cors",
        })
            .then(res => res.json())
            .then(data => {
                data.forEach(post =>{
                    output2+=`
             <div class="form-group">
                                                                        <label>ID
                                                                            <input class="form-control" id="idE"
                                                                                   type="number"
                                                                                   ${post.id}
                                                                                   readonly/></label>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>First name
                                                                            <input class="form-control" id="nameE"
                                                                                   name="name"
                                                                                  ${post.name}
                                                                                   type="text"
                                                                                   value=""/></label>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>Last name
                                                                            <input class="form-control" id="surnameE"
                                                                                   name="surname"
                                                                                   type="text"
                                                                                   ${post.surname}
                                                                                   /></label>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>Age
                                                                            <input class="form-control" id="ageE"
                                                                                   type="number" name="age"
                                                                                   ${post.age}
                                                                                  /></label>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>Email
                                                                            <input class="form-control" id="emailE"
                                                                                   type="email" name="email"
                                                                                   ${post.email}
                                                                                  /></label>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>Password
                                                                            <input class="form-control" id="passwordE" name="password"
                                                                                   type="password" /></label>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label><b>Role</b>
                                                                            <select class="custom-select"
                                                                                    multiple="multiple" size="2"
                                                                                    name="roles" id="roles">
                                                                                <option>  `
                                                                          for (const r of post.roles) {
                                                                           output2 += r.role + " ";
                                                                          }
                                                                            output2+=`
                                                                                </option>
                                                                            </select></label>
                                                                    </div>


    `;
                });
                getPost2.innerHTML = output2;
            })
    */






    /*
    обновление
    */
    // PUT

    /*  const updatePost = {
          name: 'semen',
          surname: 'post two',
          email: '2@mail.ru'
      }
      fetch(`${url}update/1`, writeServer('PUT', updatePost))
          .then(getResponse)
          .then(processJSON)
*/










    /*
        // DELETE
        deleteUser.addEventListener('click', () => {
            fetch(`admin/remove/{id}`, { method: 'DELETE' })
                .then(response=>response.json())
                .then(json=> console.log(json))
                .catch(error => console.error(error));
        });
    */






    /*


        fetch(url1, {
            mode: "no-cors",
            headers:{
                "Access-Control-Allow-Origin" : "*",
                    "Access-Control-Allow-Credentials" : true
            } })
            /!*.then( response => response.json() )
            .then( data => console.log(data) )
            //.catch( error => console.log(error) )*!/

        .then(
            res=>{
                res.json().then(
                    data=> {
                        let temp = "";
                        data.forEach((el)=>{

                            temp += `<tr>`;
                            temp += "<td> ${el.id} </td>";
                            temp += "<td> ${el.name} </td>";
                            temp += "<td> ${el.surname} </td>";
                            temp += "<td> ${el.age} </td>";
                            temp += "<td> ${el.email} </td>";
                            temp += "<td>";
                            for (const r of el.roles) {
                                temp += r.name + " ";
                            }
                            temp += "</td>";
                            temp +='<td><a id="editButton" type="button" class=" btn btn-primary" data-toggle="modal"';
                            temp +='data-target="#editModal">Edit</a></td>';
                            temp +='<td><a id="deleteButton" type="button" class="btn btn-danger" data-toggle="modal"';
                            temp +=' data-target="#deleteModal">Delete</a></td>';

                            temp += `</tr>`;
                        })
                        document.getElementById("tableBody").innerHTML = temp;
                    }
                )
            }
        )
    */


 /*   fetch(url, {
        method: 'POST',
        headers: {
            'Content-type': 'application/json'
        },
        body: JSON.stringify({

            name: 'Alexeeee',
            roles: ['ROLE_ADMIN'],
            password: '22'

        })


    })
        .then(response => response.json())
        .then(json => console.log(json))
        .catch(error => console.error('addUser error'));*/


</script>


<!--<script src="app.js"></script>-->
</body>
</html>